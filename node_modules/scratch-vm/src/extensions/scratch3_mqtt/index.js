/*
This is the Scratch 3 extension to remotely control an
MQTT
 */
// Boiler plate from the Scratch Team

const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const formatMessage = require('format-message');

// mqtt Modes
let mqtt = require('mqtt')

require('sweetalert');
//async await estea
require('babel-polyfill');


let the_locale = null;

//mqtt message
let mqtt_message = null;
let client = null;
const ContentPort = {
    'en': 'Connect mqtt server [URL] ',
    'zh-tw': '連線到mqtt server [URL]',
};

const Subscribe_Topic = {
    'en': 'Subscribe topic:[TOPIC]',
    'zh-tw': '訂閱主題:[TOPIC]',
};

const FormDmqttMsg = {
    'en': 'MQTT Message',
    'zh-tw': 'MQTT訊息',
};

const Publish_Topic = {
    'en': 'Publish topic [TOPIC] message [PUBLISH]',
    'zh-tw': '發佈主題[TOPIC]訊息:[PUBLISH]',
};

class Scratch3Mqtt {
    constructor(runtime) {
        the_locale = this._setLocale();
        this.runtime = runtime;
    }

    getInfo() {
        the_locale = this._setLocale();
        return {
            id: 'mqtt',
            color1: '#003D79', //'#0C5986',
            color2: '#34B0F7',
            name: 'MQTT',
            blockIconURI: 'data:image/png;base64,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',
            blocks: [
                {
                    opcode: 'connect_mqtt',
                    blockType: BlockType.COMMAND,
                    text: ContentPort[the_locale],
                    arguments: {
                        URL: {
                            type: ArgumentType.STRING,
                            defaultValue: 'ws://broker.hivemq.com:8000/mqtt',
                            //defaultValue: 'ws://broker.emqx.io'
                        }
                    },

                },
                {
                    opcode: 'subscribe_topic',
                    blockType: BlockType.COMMAND,
                    text: Subscribe_Topic[the_locale],
                    arguments: {
                        TOPIC: {
                            type: ArgumentType.STRING,
                            defaultValue: 'osep',
                        }
                    },

                },
                {
                    opcode: 'publish_topic',
                    blockType: BlockType.COMMAND,
                    text: Publish_Topic[the_locale],
                    arguments: {
                        TOPIC: {
                            type: ArgumentType.STRING,
                            defaultValue: 'osep',
                        },
                        PUBLISH:{
                            type: ArgumentType.STRING,
                            defaultValue: 'Hello osep',
                        }
                    },
                },
                {
                    opcode: 'mqtt_msg',
                    blockType: BlockType.REPORTER,
                    text: FormDmqttMsg[the_locale],
                    arguments: {
                        /*PIN: {
                            type: ArgumentType.NUMBER,
                            defaultValue: '8',
                            menu: 'digital_pins'
                        },*/
                        id: {
                            type: ArgumentType.STRING,
                            defaultValue: 'id'
                        }
                    }
                },
            ],
            menus: {
                digital_pins: {
                    acceptReporters: true,
                    items: ['2', '3', '4', '5', '6', '7', '8', '9', '10', '11',
                        '12', '13','14(A0)','15(A1)','16(A2)','17(A3)','18(A4)','19(A5)']
                },
            }
        };
    }

    // command blocks
        isMqtt_msg(){

        } 

    async mqtt_msg(){
        client.on('message', function (topic, message, packet) {
            mqtt_message = topic+':'+message.toString();  
        })
            //if (this.isMqtt_msg()) {
                console.log('return ', mqtt_message);
                return mqtt_message;
            //}
            //return readFromMqttErr[theLocale];
    }

    async connect_mqtt(args) {
        const clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8);
        //var host = 'ws://localhost:8080'
        const url = args.URL;
        console.log(url);
        const options = {
            keepalive: 30,
            clientId: clientId,
                protocolId: 'MQTT',
                protocolVersion: 4,
                clean: true,
                reconnectPeriod: 1000,
                connectTimeout: 30 * 1000,
                will: {
                    topic: 'WillMsg',
                    payload: 'Connection Closed abnormally..!',
                    qos: 0,
                    retain: false
                },
                rejectUnauthorized: false
        }
        client = mqtt.connect(url, options)
        client.on('error', function (err) {
            console.log(err)
            client.end()
          })
          
          client.on('connect', function () {
            console.log('client connected:' + clientId)
            mqtt_message = 'connected';
            //client.subscribe('osep', { qos: 0 })
            //client.publish('osep', 'wss secure connection demo...!', { qos: 0, retain: false })
          })
          /*
          client.on('message', function (topic, message, packet) {
            mqtt_message = message.toString() + '\nOn topic:= ' + topic;  
            console.log('Received Message:= ' + mqtt_message);
          })
          */
          client.on('close', function () {
            console.log(clientId + ' disconnected')
          })
    }

    async publish_topic(args){
        const topic = args.TOPIC;
        const publish_string = args.PUBLISH;
        client.publish(topic, publish_string, { qos: 0, retain: false });
        console.log('topic,publish_string',topic+','+publish_string);
    }

    async subscribe_topic(args){
        const topic = args.TOPIC;
        console.log(client);
        client.subscribe(topic, { qos: 0 });
        mqtt_message = topic;
        /*
        await client.on('connect', function () {
            console.log('client connected:' + clientId)
            client.subscribe(topic, { qos: 0 })
            mqtt_message = topic;
          })*/
    }

    // end of block handlers

    _setLocale () {
        let now_locale = '';
        switch (formatMessage.setup().locale){
            case 'pt-br':
            case 'pt':
                now_locale='pt-br';
                break;
            case 'en':
                now_locale='en';
                break;
            case 'fr':
                now_locale='fr';
                break;
            case 'zh-tw':
                now_locale= 'zh-tw';
                break;
            case 'zh-cn':
                now_locale= 'zh-cn';
                break;
            case 'pl':
                now_locale= 'pl';
                break;
            default:
                now_locale='en';
                break;
        }
        return now_locale;
    }

    // helpers

}
    
module.exports = Scratch3Mqtt;
